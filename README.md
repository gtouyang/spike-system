# spike-system
upload on 2019-07-22

## 目前完成内容

1. 前端页面
2. Eureka服务注册中心
3. 商品创建查询服务

## 待完成内容

1. 客户端服务
2. 前后端对接
3. 下单服务
4. 支付服务
5. 帐号认证中心
6. 数据库同步服务

## 秒杀流程设计

![](http://qiniuyun.gtouyang.com/%E7%A7%92%E6%9D%80%E7%B3%BB%E7%BB%9F%E7%A7%92%E6%9D%80%E6%B5%81%E7%A8%8B%E5%9B%BE.png)

1. 客户端向秒杀服务发送下单请求
2. 秒杀服务接收请求，在redis中查询剩余库存，库存充足则以乐观锁的形式减库存
3. 减库存成功在另一个redis中添加订单，添加订单成功后将订单ID发送给客户端
4. 客户端接收订单ID后使用该ID向支付服务发送支付请求
5. 支付服务从redis中获取该订单详细信息，随后在用户数据库中扣款
6. 将扣款结果返回给客户端，若扣款成功则添加到已完成消息队列



- 检查订单服务定时检查redis中的订单，将过期的订单从redis中删除，放入已取消消息队列
  - redis中维护一个设置过期时间的`orderSet`，当有成员过期时发送消息给检查订单服务，然后订单服务根据ID在`orderMap`中获取对应的order，之后从`orderMap` 移除该order，并在`productMap`中增加对应的库存
  - 若redis内存不足，将快过期的order从redis先移动到mysql中，但并不是放入总表中，先在一个临时表中存起来，定期检查临时表中的过期信息
- 同步数据库服务监听已完成订单消息队列和已取消订单消息队列，将消息同步到MySQL数据库
